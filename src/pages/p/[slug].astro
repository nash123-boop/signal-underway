---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("posts");
  return posts.map((p) => ({
    params: { slug: p.slug },
    props: { id: p.id },
  }));
}

const { id } = Astro.props;
const posts = await getCollection("posts");
const post = posts.find((p) => p.id === id);

if (!post) return Astro.redirect("/latest");

const others = posts
  .filter((p) => p.id !== post.id)
  .sort((a, b) => b.data.publishDate.localeCompare(a.data.publishDate))
  .slice(0, 4);

const cover = post.data.cover ?? "/og-default.png";

const site = Astro.site?.toString() ?? "https://thenationalsignal.pages.dev";
const url = new URL(`/p/${post.slug}`, site).toString();

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": post.data.title,
  "description": post.data.deck,
  "datePublished": post.data.publishDate,
  "author": { "@type": "Organization", "name": "The National Signal" },
  "mainEntityOfPage": url,
  "image": new URL(cover, site).toString(),
  "publisher": { "@type": "Organization", "name": "The National Signal" },
};
---
<BaseLayout
  title={`${post.data.title} — The National Signal`}
  description={post.data.deck}
  ogImage={cover}
>
  <div class="article">
    <div class="articleWrap">
      <div class="meta">
        <span class="badge">{post.data.category}</span>
        <span>{post.data.publishDate}</span>
        {post.data.tags?.slice(0, 3).map((t) => <span class="badge">{t}</span>)}
      </div>

      <h1>{post.data.title}</h1>
      <p class="sub">{post.data.deck}</p>

      <figure class="heroMedia">
        <img
          src={cover}
          alt=""
          loading="eager"
          decoding="async"
        />
      </figure>

      <div class="hr"></div>

      <div class="prose">
        <slot />
      </div>

      <div class="hr"></div>

      <div class="callout">
        <strong>Reader note:</strong> We publish <em>signals</em> — patterns supported by publicly observable traces.
        If you have primary-source links or corrections, send them to <strong>tips@yourdomain</strong>.
      </div>

      <div class="hr"></div>

      <div class="sectionTitle">Read next</div>
      <div class="list">
        {others.map((p) => {
          const c = p.data.cover ?? "/og-default.png";
          return (
            <a class="item" href={`/p/${p.slug}`}>
              <div class="itemInner">
                <div class="meta">
                  <span class="badge">{p.data.category}</span>
                  <span>{p.data.publishDate}</span>
                </div>
                <h3>{p.data.title}</h3>
                <p>{p.data.deck}</p>
              </div>

              <div class="thumb" aria-hidden="true">
                <img src={c} alt="" loading="lazy" decoding="async" />
              </div>
            </a>
          );
        })}
      </div>
    </div>

    <script type="application/ld+json">{JSON.stringify(jsonLd)}</script>
  </div>
</BaseLayout>
