---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const { slug } = Astro.params;
const posts = await getCollection("posts");
const post = posts.find(p => p.slug === slug);

if (!post) return Astro.redirect("/latest");

const others = posts
  .filter(p => p.id !== post.id)
  .sort((a,b) => b.data.publishDate.localeCompare(a.data.publishDate))
  .slice(0, 4);

const site = Astro.site?.toString() ?? "https://signal-underway.example";
const url = new URL(`/p/${post.slug}`, site).toString();

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": post.data.title,
  "description": post.data.deck,
  "datePublished": post.data.publishDate,
  "author": { "@type": "Organization", "name": "Signal Underway" },
  "mainEntityOfPage": url,
  "image": post.data.cover ? new URL(post.data.cover, site).toString() : new URL("/og-default.png", site).toString(),
  "publisher": { "@type": "Organization", "name": "Signal Underway" }
};
---
<BaseLayout
  title={`${post.data.title} — Signal Underway`}
  description={post.data.deck}
  ogImage={post.data.cover ?? "/og-default.png"}
>
  <article class="article">
    <div class="pillrow" style="margin-top:14px">
      <span class="pill">{post.data.category}</span>
      {post.data.tags?.slice(0,3).map((t) => <span class="pill">{t}</span>)}
    </div>

    <h1>{post.data.title}</h1>
    <p class="sub">{post.data.deck}</p>

    {post.data.cover && <img class="cover" src={post.data.cover} alt="" loading="eager" style="height:240px;border-radius:18px;border:1px solid var(--line)"/>}

    <div class="meta" style="margin-top:12px">
      <span>Published</span><span class="dot">•</span><span>{post.data.publishDate}</span>
    </div>

    <div class="hr"></div>

    <div class="prose">
      <slot />
    </div>

    <div class="hr"></div>

    <div class="callout">
      <strong>Reader note:</strong> This site publishes <em>signals</em> — patterns supported by publicly observable traces.
      We avoid certainty. If you have primary-source links or corrections, send them to <strong>tips@yourdomain</strong>.
    </div>

    <section class="readnext">
      <h2 style="margin:18px 0 6px 0;font-size:15px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)">Read next</h2>
      {others.map((p) => (
        <a class="item" href={`/p/${p.slug}`}>
          <div class="itemInner">
            <div class="meta">
              <span class="badge">{p.data.category}</span><span class="dot">•</span><span>{p.data.publishDate}</span>
            </div>
            <h3>{p.data.title}</h3>
            <p>{p.data.deck}</p>
          </div>
        </a>
      ))}
    </section>
  </article>

  <script type="application/ld+json">{JSON.stringify(jsonLd)}</script>
</BaseLayout>
