---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

// Generate static paths
export async function getStaticPaths() {
  const posts = await getCollection("posts");
  return posts.map((p) => ({
    params: { slug: p.slug },
    props: { id: p.id },
  }));
}

const { id } = Astro.props;
const posts = await getCollection("posts");
const post = posts.find((p) => p.id === id);

if (!post) return Astro.redirect("/latest");

// ðŸ”¥ AUTOMATIC COVER SYSTEM
const category = post.data.category?.toLowerCase() ?? "";
const coverImage = `/covers/${category}.jpg`;
const fallbackImage = "/covers/default.jpg";

const finalCover = coverImage;

// Related posts
const others = posts
  .filter((p) => p.id !== post.id)
  .sort((a, b) => b.data.publishDate.localeCompare(a.data.publishDate))
  .slice(0, 4);

const site = Astro.site?.toString() ?? "https://signal-underway.pages.dev";
const url = new URL(`/p/${post.slug}`, site).toString();
---

<BaseLayout
  title={`${post.data.title} â€” The National Signal`}
  description={post.data.deck}
  ogImage={finalCover}
>

  <article class="article">

    <h1>{post.data.title}</h1>
    <p class="sub">{post.data.deck}</p>

    <!-- ðŸ”¥ ALWAYS SHOW COVER IMAGE -->
    <img
      src={finalCover}
      alt=""
      loading="eager"
      style="width:100%;height:420px;object-fit:cover;margin:20px 0;"
      onerror={`this.onerror=null;this.src='${fallbackImage}'`}
    />

    <div class="meta">
      <span>{post.data.category}</span>
      <span>â€¢</span>
      <span>{post.data.publishDate}</span>
    </div>

    <div class="prose">
      <slot />
    </div>

  </article>

</BaseLayout>
